external procedure ExtractObj(string,var Integer,var string);external function val AbsoluteVal(val);external function roundmode SetRoundModeD(Integer);external function Boolean IsDigit(string);external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string);external procedure XmlXlsxWorkBegin(string,string);external procedure CreateSheetsXLSX(integer,array string,string,integer,boolean);external procedure EndSheet(integer,string,integer);external procedure SetSheetsCols(integer,array val,array integer,string);external procedure BeginSheetData(integer,string);external procedure EndSheetData(integer,string);external procedure BeginRow(integer,string,integer,integer,val);external procedure EndRow(integer,string,var integer);external procedure StringCell(integer,string,var integer,integer,integer,string,var array string,var integer,var integer);external procedure NumericCell(integer,string,var integer,integer,integer,val);external procedure EmptyCell(integer,string,var integer,integer,integer,integer);external procedure MergeCells(integer,string,array string,integer);external procedure FillSharedStrings(string,array string,integer,integer,array string);external procedure ConvertToXLSX(string,boolean);external function string 10 GetStringCellNum(integer,integer);SetLangMode(LangRussian,"UKR",0);global function string 255 NewM4PadString(string instr,Integer padlen,string padchar,Boolean padleft)BEGIN  string 255 tstr,t2;  Integer i;  Integer toff;    toff = 0;  for (i = 1; i<=padlen ;i=i+1) begin tstr = tstr & padchar; end;  if (padleft) then begin    tstr = tstr & instr;    tstr = Right(tstr,(len(tstr)-len(instr)));      end else begin    t2 = tstr;    tstr = instr;    tstr = tstr & t2;    tstr = Left(tstr,padlen);  end;    NewM4PadString = tstr;  RETURN;END;function boolean IsStringNumeric(string s)begin  integer i;  boolean res;    res = true;  for (i=0;i<len(s);i=i+1) begin    if (IsDigit(mid(s,i,1))==false) then begin      res = false;      i = len(s)+1;    end;  end;    IsStringNumeric = res;  return;end;procedure SendFileFTP(record SamsungSettingsBlock SFtpb,string outsalesfile)begin  string 255 tstr;        tstr = SFtpb.HostIP & " " & SFtpb.Port & " ";  	if (NonBlank(SFtpb.Login)) then begin  	  tstr = tstr & SFtpb.Login & " ";  	end else begin  	  tstr = tstr & "anonymous ";  	end;  	if (NonBlank(SFtpb.Password)) then begin  	  tstr = tstr & SFtpb.Password & " ";  	end else begin  	  tstr = tstr & "password ";  	end;  	tstr = tstr & SFtpb.DirName & " " & outsalesfile;  	  	logtext(0,"ftptransfer.sh " & tstr);  	  	millisleep(500);  	RunProgram("Samsung_EDI_Export/ftptransfer.sh", tstr);    return;end;globalupdating procedure SamsungSendFilesToFtpMn(record RcVc RepSpec)begin  record IVVc IVr;  record IVcashVc IVcashr;  row IVcashVc IVcashrw;  record INVc INr;  record SamsungItemsBlock SIb;  row SamsungItemsBlock SIrw;  record SamsungSettingsBlock SFtpb;  record ItemStatusVc ISr;  record SHVc SHr;  row SHVc SHrw;  record ORVc ORr;  row ORVc ORrw;  record UserVc Userr;  date sd,ed;  time curtime;  string 255 filenameIMEI,filenameAcces,filenameInvent,folder,locations,curindex,identificator,tstr;  boolean TrHs,testf,includeIMEI,includeAcces,samsuf;  string 20 timeStamp,timeStamp1,senddate;  area IMEIarea,accessArea,inventArea;  integer i,rwcnt,invoiceCnt;  string 4 linefeed,padchar;  vector val inventoryList;  array string 255 indexes;  val tval;  vector boolean findf;  record SamsungSendLog1Vc SSLr;		 linefeed = Chr(10); 	 padchar = " ";	 	 sd = RepSpec.sStartDate;	 ed = RepSpec.sEndDate;	 	 	 	 BlockLoad(SFtpb);	 locations = SFtpb.Locations;	 if (blank(locations)) then begin	   goto LSamsungSendFilesToFtpMn;	 end; 	 	 BlockLoad(SFtpb);   if (Blank(SFtpb.HostIP) or Blank(SFtpb.DirName) or Blank(SFtpb.Port)) then begin   		  goto LSamsungSendFilesToFtpMn;	 end;	 	 SSLr.TransDate = sd;	 if(readfirstkey("TransDate",SSLr,1,true))then begin	 	if(nonblank(SSLr.FileName1) and nonblank(SSLr.FileName2) and nonblank(SSLr.FileName3))then begin	 		SendFileFTP(SFtpb,SSLr.FileName1);	 		millisleep(200);	 		SendFileFTP(SFtpb,SSLr.FileName2);	 		millisleep(200);	 		SendFileFTP(SFtpb,SSLr.FileName3);	 		goto LSamsungSendFilesToFtpMn;	 	end;	 end;	 	 	 	 if (SFtpb.SalesNextDocNum<=0) then begin	   SFtpb.SalesNextDocNum = 1;	 end;	 if (SFtpb.SalesNextDocNum2<=0) then begin	   SFtpb.SalesNextDocNum2 = 1;	 end;		 if (BlankDate(sd)) then begin		 sd = CurrentDate;	 end;	 if (BlankDate(ed)) then begin		 ed = CurrentDate;	 end;	 	 blockload(SIb);   rwcnt = matrowcnt(SIb);   For(i=0;i<rwcnt;i=i+1) begin	   matrowget(SIb,i,SIrw);	   findf[SIrw.ArtCode] = true;	 end; 		 senddate = DateToString(sd,"YYYYMMDD");	 timeStamp = senddate;	 curtime = CurrentTime;	 if (len(GetHour(curtime))==1) then begin	   timeStamp = timeStamp & "0" & GetHour(curtime);	 end else begin	   timeStamp = timeStamp & GetHour(curtime);	 end;	 if (len(GetMinute(curtime))==1) then begin	   timeStamp = timeStamp & "0" & GetMinute(curtime);	 end else begin	   timeStamp = timeStamp & GetMinute(curtime);	 end;	 timeStamp1 = timeStamp;	 if (len(GetSecond(curtime))==1) then begin	   timeStamp = timeStamp & "0" & GetSecond(curtime);	 end else begin	   timeStamp = timeStamp & GetSecond(curtime);	 end;	 curtime = AddSeconds(curtime,1);	 if (len(GetSecond(curtime))==1) then begin	   timeStamp1 = timeStamp1 & "0" & GetSecond(curtime);	 end else begin	   timeStamp1 = timeStamp1 & GetSecond(curtime);	 end;	 	 folder = SFtpb.DirName;	 /*if (left(folder,1)=="/") then begin	   folder = Right(folder,Len(folder)-1);	 end;	 if (Right(folder,1)=="/") then begin	   folder = Left(folder,Len(folder)-1);	 end;	 if (DIREXISTS(folder)==false) then begin	   if (CreateFolder(folder)==false) then begin	     goto LSamsungSendFilesToFtpMn;	   end;	 end;	 folder = folder & "/";*/	 //Sales IMEI	 filenameIMEI = "secmcs01_" & SFtpb.SenderCode & "_" & timeStamp & ".txt";	 CreateFile(folder & filenameIMEI);	 CloseFile;	 	 //Sales Accessories	 filenameAcces = "PCISTD2.C962." & SFtpb.SenderCode & "." & timeStamp & ".txt";	 CreateFile(folder & filenameAcces);	 CloseFile;	 	 //Inventory	 filenameInvent = "PCISTD2.C962." & SFtpb.SenderCode & "." & timeStamp1 & ".txt";	 CreateFile(folder & filenameInvent);	 CloseFile;    	 //Header Accessories	 AddTextToArea(NewM4PadString("C962",4,padchar,false), accessArea); //SECCOD   AddTextToArea(NewM4PadString("S",4,padchar,false), accessArea); //DOCCAT     AddTextToArea(NewM4PadString(SFtpb.SenderName,50,padchar,false), accessArea); //SNDNAM   AddTextToArea(NewM4PadString("ST",2,padchar,false), accessArea); //SNDTYP   AddTextToArea(NewM4PadString(SFtpb.SenderCode,50,padchar,false), accessArea); //SNDCOD   AddTextToArea(NewM4PadString(SFtpb.SalesNextDocNum,14,padchar,false), accessArea); //DOCNUM   AddTextToArea(NewM4PadString(senddate,8,padchar,false), accessArea); //DOCDAT   AddTextToArea("Z" & linefeed, accessArea); //HDRFLG   	 //Header Inventory	 AddTextToArea(NewM4PadString("C962",4,padchar,false), inventArea); //SECCOD   AddTextToArea(NewM4PadString("I",4,padchar,false), inventArea); //DOCCAT     AddTextToArea(NewM4PadString(SFtpb.SenderName,50,padchar,false), inventArea); //SNDNAM   AddTextToArea(NewM4PadString("ST",2,padchar,false), inventArea); //SNDTYP   AddTextToArea(NewM4PadString(SFtpb.SenderCode,50,padchar,false), inventArea); //SNDCOD   AddTextToArea(NewM4PadString(SFtpb.SalesNextDocNum2,14,padchar,false), inventArea); //DOCNUM   AddTextToArea(NewM4PadString(senddate,8,padchar,false), inventArea); //DOCDAT   AddTextToArea("Z" & linefeed, inventArea); //HDRFLG	 	  TrHs = true;	  IVcashr.TransDate = sd;	  While(LoopKey("TransDate",IVcashr,1,TrHs)) begin      testf = true;	    if (blank(IVcashr.Location) or IVcashr.Location!=locations) then begin testf = false; end;	 	  if (IVcashr.TransDate<sd) then begin testf = false; end;	 	  if (IVcashr.TransDate>ed) then begin TrHs = false; testf = false; end;	 	  if (testf) then begin			  rwcnt = MatRowCnt(IVcashr);			  for(i=0;i<rwcnt;i=i+1) begin				  MatRowGet(IVcashr,i,IVcashrw);				  if (NonBlank(IVcashrw.ArtCode)) then begin				 	  INr.Code = IVcashrw.ArtCode;				 	  ReadFirstMain(INr,1,true);				 	  if (NonBlank(INr.EUCodex)) then begin               identificator =  INr.EUCodex;            end else begin              identificator = INr.Code;            end;				 	  if (INr.Terminated==1) then begin testf=false; end;            if (INr.Code=="PREPAYMENT") then begin testf=false; end;            if (findf[identificator]==false) then begin testf=false; end;				 	  if (testf) then begin				 	    samsuf = false;				 	    if (INr.Group=="SAMSU") then begin //IMEI                if ((NonBlank(IVcashrw.SerialNr) or NonBlank(IVcashrw.IMEI))) then begin                  if (includeIMEI==false) then begin                    includeIMEI = true;                  end;                  if (NonBlank(IVcashrw.IMEI)) then begin                    curindex = IVcashrw.IMEI;                  end else begin                    curindex = IVcashrw.SerialNr;                  end;                  AddTextToArea(NewM4PadString("C962",4,padchar,false), IMEIarea); //CompanyCode                  AddTextToArea(NewM4PadString(senddate,8,padchar,false), IMEIarea); //DocDate                  AddTextToArea(NewM4PadString(DateToString(IVcashr.TransDate,"YYYYMMDD"),8,padchar,false), IMEIarea); //SalesDate                  AddTextToArea(NewM4PadString(SFtpb.SenderCode,20,padchar,false), IMEIarea); //PartnerCode                  AddTextToArea(NewM4PadString(SFtpb.SenderName,30,padchar,false), IMEIarea); //PartnerName                  AddTextToArea(NewM4PadString("ST",2,padchar,false), IMEIarea); //PartnerCodeType                  AddTextToArea(NewM4PadString(SFtpb.LocationCode,20,padchar,false), IMEIarea); //LocationCode                  AddTextToArea(NewM4PadString("ST",2,padchar,false), IMEIarea); //LocationType                  AddTextToArea(NewM4PadString("EU",50,padchar,false), IMEIarea); //ToPartnerCode                  AddTextToArea(NewM4PadString(identificator,20,padchar,false), IMEIarea); //SKU                  AddTextToArea(NewM4PadString("",20,padchar,false), IMEIarea); //EAN/UPC// Edit ************************** Friday, 29 April 2016 16:51:02                  AddTextToArea(NewM4PadString("",20,padchar,false), IMEIarea); //PartnerModelCode// Edit ************************** Friday, 29 April 2016 16:51:03                  AddTextToArea(NewM4PadString(curindex,20,padchar,false), IMEIarea); //IMEI                  AddTextToArea(NewM4PadString(ValToString(IVcashrw.Quant,M4Val,"",".",0),10,padchar,false), IMEIarea); //QTY                  AddTextToArea(NewM4PadString(ValToString(IVcashrw.Price,M4Val,"",".",0),10,padchar,false), IMEIarea); //UnitPrice                  AddTextToArea(NewM4PadString("",20,padchar,false), IMEIarea); //EndUserPhoneNo                  AddTextToArea(NewM4PadString("",30,padchar,false), IMEIarea); //EndUserName                  Userr.Code = IVcashr.SalesMan;                  ReadFirstMain(Userr,1,true);                  if (Userr.Code!="OL" and Userr.Code!="OL1") then begin                    tstr = Userr.Name;                  end else begin                    tstr = "";                  end;                  AddTextToArea(NewM4PadString(tstr,30,padchar,false), IMEIarea); //ETC1                  AddTextToArea(NewM4PadString("",30,padchar,false), IMEIarea); //ETC2                  AddTextToArea(NewM4PadString("",30,padchar,false), IMEIarea); //ETC3                  AddTextToArea("Z" & linefeed, IMEIarea); //ITMFLG                                    //vector for inventory                  if (IVcashrw.Quant>0) then begin                    inventoryList[IVcashrw.ArtCode] = inventoryList[IVcashrw.ArtCode] + IVcashrw.Quant;                  end else begin                    inventoryList[IVcashrw.ArtCode] = inventoryList[IVcashrw.ArtCode] - IVcashrw.Quant;                  end;                  samsuf = true;                end;              end;			 	      if (INr.Group=="SMG_A" or samsuf) then begin //Accessory      				 	if (includeAcces==false) then begin                  includeAcces = true;                end;    				 	  AddTextToArea(NewM4PadString(SFtpb.SenderCode,10,padchar,false), accessArea); //PTNCOD    				 	  AddTextToArea(NewM4PadString(DateToString(IVcashr.TransDate,"YYYYMMDD"),8,padchar,false), accessArea); //ITMDAT    				 	  AddTextToArea(NewM4PadString("",8,padchar,false), accessArea); //STADAT    				 	  AddTextToArea(NewM4PadString("",8,padchar,false), accessArea); //ENDDAT    				 	  AddTextToArea(NewM4PadString(identificator,20,padchar,false), accessArea); //SECMOD    				 	  AddTextToArea(NewM4PadString("",20,padchar,false), accessArea); //EANUPC// Edit ************************** Friday, 29 April 2016 16:51:21    				 	  AddTextToArea(NewM4PadString("",30,padchar,false), accessArea); //PTNMOD// Edit ************************** Friday, 29 April 2016 16:51:21    				 	  AddTextToArea(NewM4PadString(SFtpb.LocationCode,30,padchar,false), accessArea); //LOCCOD    				 	  AddTextToArea(NewM4PadString("ST",2,padchar,false), accessArea); //LOCTYP    				 	  AddTextToArea(NewM4PadString("",20,padchar,false), accessArea); //CHNSRC    				 	  AddTextToArea(NewM4PadString("",20,padchar,false), accessArea); //CHNCAT    				 	  AddTextToArea(NewM4PadString("",20,padchar,false), accessArea); //PTN2CD    				 	  AddTextToArea(NewM4PadString("",20,padchar,false), accessArea); //PTNAGT    				 	  if (IVcashrw.Quant<0) then begin    				 	    AddTextToArea(NewM4PadString("SR",10,padchar,false), accessArea); //QTYTYP    				 	  end else begin    				 	    AddTextToArea(NewM4PadString("SN",10,padchar,false), accessArea); //QTYTYP    				 	  end;    				 	  AddTextToArea(NewM4PadString(ValToString(AbsoluteVal(IVcashrw.Quant),M4Val,"",".",0),10,padchar,false), accessArea); //QTY    				 	  AddTextToArea(NewM4PadString(ValToString(AbsoluteVal(IVcashrw.Sum),M4Val,"",".",0),10,padchar,false), accessArea); //AMT    				 	  AddTextToArea(NewM4PadString("UAH",3,padchar,false), accessArea); //CUR    				 	  AddTextToArea(NewM4PadString("",50,padchar,false), accessArea); //RESRV1    				 	  AddTextToArea(NewM4PadString("",50,padchar,false), accessArea); //RESRV2     				 	  AddTextToArea(NewM4PadString("",50,padchar,false), accessArea); //RESRV3     				 	  AddTextToArea(NewM4PadString("",50,padchar,false), accessArea); //RESRV4                AddTextToArea("Z" & linefeed, accessArea); //ITMFLG                                   //vector for inventory                if (IVcashrw.Quant>0) then begin                  inventoryList[IVcashrw.ArtCode] = inventoryList[IVcashrw.ArtCode] + IVcashrw.Quant;                end else begin                  inventoryList[IVcashrw.ArtCode] = inventoryList[IVcashrw.ArtCode] - IVcashrw.Quant;                end;                end;            end;          end;  	        end;      end;    end;        TrHs = true;    SHr.ShipDate = sd;    While(LoopKey("ShipDate",SHr,1,TrHs)) begin      testf = true;      if (blank(SHr.Location) or SHr.Location!=locations) then begin testf = false; end;      if (SHr.ShipDate<sd) then begin testf = false; end;      if (SHr.ShipDate>ed) then begin TrHs = false; testf = false; end;      if (testf) then begin        rwcnt = MatRowCnt(SHr);        for(i=0;i<rwcnt;i=i+1) begin          MatRowGet(SHr,i,SHrw);          if (NonBlank(SHrw.ArtCode)) then begin            INr.Code = SHrw.ArtCode;            ReadFirstMain(INr,1,true);            if (NonBlank(INr.EUCodex)) then begin               identificator =  INr.EUCodex;            end else begin              identificator = INr.Code;            end;            if (INr.Terminated==1) then begin testf=false; end;            if (INr.Code=="PREPAYMENT") then begin testf=false; end;            if (findf[identificator]==false) then begin testf=false; end;            if (testf) then begin              samsuf = false;              if (INr.Group=="SAMSU") then begin //IMEI                if ((NonBlank(SHrw.SerialNr) or NonBlank(SHrw.IMEI))) then begin                  if (includeIMEI==false) then begin                    includeIMEI = true;                  end;                  if (NonBlank(SHrw.IMEI)) then begin                    curindex = SHrw.IMEI;                  end else begin                    curindex = SHrw.SerialNr;                  end;                                    AddTextToArea(NewM4PadString("C962",4,padchar,false), IMEIarea); //CompanyCode                  AddTextToArea(NewM4PadString(senddate,8,padchar,false), IMEIarea); //DocDate                  AddTextToArea(NewM4PadString(DateToString(SHr.ShipDate,"YYYYMMDD"),8,padchar,false), IMEIarea); //SalesDate                  AddTextToArea(NewM4PadString(SFtpb.SenderCode,20,padchar,false), IMEIarea); //PartnerCode                  AddTextToArea(NewM4PadString(SFtpb.SenderName,30,padchar,false), IMEIarea); //PartnerName                  AddTextToArea(NewM4PadString("ST",2,padchar,false), IMEIarea); //PartnerCodeType                  AddTextToArea(NewM4PadString(SFtpb.LocationCode,20,padchar,false), IMEIarea); //LocationCode                  AddTextToArea(NewM4PadString("ST",2,padchar,false), IMEIarea); //LocationType                  AddTextToArea(NewM4PadString("EU",50,padchar,false), IMEIarea); //ToPartnerCode                  AddTextToArea(NewM4PadString(identificator,20,padchar,false), IMEIarea); //SKU                  AddTextToArea(NewM4PadString("",20,padchar,false), IMEIarea); //EAN/UPC// Edit ************************** Friday, 29 April 2016 16:51:33                  AddTextToArea(NewM4PadString("",20,padchar,false), IMEIarea); //PartnerModelCode// Edit ************************** Friday, 29 April 2016 16:51:34                  AddTextToArea(NewM4PadString(curindex,20,padchar,false), IMEIarea); //IMEI                  AddTextToArea(NewM4PadString(ValToString(SHrw.Ship,M4Val,"",".",0),10,padchar,false), IMEIarea); //QTY                  ORr.SerNr = SHr.OrderNr;                  ReadFirstMain(ORr,1,true);                  MatRowGet(ORr,SHrw.OrdRow,ORrw);                  AddTextToArea(NewM4PadString(ValToString(ORrw.Price,M4Val,"",".",0),10,padchar,false), IMEIarea); //UnitPrice                  AddTextToArea(NewM4PadString("",20,padchar,false), IMEIarea); //EndUserPhoneNo                  AddTextToArea(NewM4PadString("",30,padchar,false), IMEIarea); //EndUserName                  Userr.Code = IVcashr.SalesMan;                  ReadFirstMain(Userr,1,true);                  if (Userr.Code!="OL" and Userr.Code!="OL1") then begin                    tstr = Userr.Name;                  end else begin                    tstr = "";                  end;                  AddTextToArea(NewM4PadString(tstr,30,padchar,false), IMEIarea); //ETC1                  AddTextToArea(NewM4PadString("",30,padchar,false), IMEIarea); //ETC2                  AddTextToArea(NewM4PadString("",30,padchar,false), IMEIarea); //ETC3                  AddTextToArea("Z" & linefeed, IMEIarea); //ITMFLG                  samsuf = true;                end;              end;              if (INr.Group=="SMG_A" or samsuf) then begin //Accessory                if (includeAcces==false) then begin                  includeAcces = true;                end;                AddTextToArea(NewM4PadString(SFtpb.SenderCode,10,padchar,false), accessArea); //PTNCOD    				 	  AddTextToArea(NewM4PadString(DateToString(SHr.ShipDate,"YYYYMMDD"),8,padchar,false), accessArea); //ITMDAT    				 	  AddTextToArea(NewM4PadString("",8,padchar,false), accessArea); //STADAT    				 	  AddTextToArea(NewM4PadString("",8,padchar,false), accessArea); //ENDDAT    				 	  AddTextToArea(NewM4PadString(identificator,20,padchar,false), accessArea); //SECMOD    				 	  AddTextToArea(NewM4PadString("",20,padchar,false), accessArea); //EANUPC// Edit ************************** Friday, 29 April 2016 16:51:54    				 	  AddTextToArea(NewM4PadString("",30,padchar,false), accessArea); //PTNMOD// Edit ************************** Friday, 29 April 2016 16:51:55    				 	  AddTextToArea(NewM4PadString(SFtpb.LocationCode,30,padchar,false), accessArea); //LOCCOD    				 	  AddTextToArea(NewM4PadString("ST",2,padchar,false), accessArea); //LOCTYP    				 	  AddTextToArea(NewM4PadString("",20,padchar,false), accessArea); //CHNSRC    				 	  AddTextToArea(NewM4PadString("",20,padchar,false), accessArea); //CHNCAT    				 	  AddTextToArea(NewM4PadString("",20,padchar,false), accessArea); //PTN2CD    				 	  AddTextToArea(NewM4PadString("",20,padchar,false), accessArea); //PTNAGT    				 	  AddTextToArea(NewM4PadString("SN",10,padchar,false), accessArea); //QTYTYP    				 	  AddTextToArea(NewM4PadString(ValToString(SHrw.Ship,M4Val,"",".",0),10,padchar,false), accessArea); //QTY    				 	  ORr.SerNr = SHr.OrderNr;                ReadFirstMain(ORr,1,true);                MatRowGet(ORr,SHrw.OrdRow,ORrw);    				 	  AddTextToArea(NewM4PadString(ValToString(ORrw.Sum,M4Val,"",".",0),10,padchar,false), accessArea); //AMT    				 	  AddTextToArea(NewM4PadString("UAH",3,padchar,false), accessArea); //CUR    				 	  AddTextToArea(NewM4PadString("",50,padchar,false), accessArea); //RESRV1    				 	  AddTextToArea(NewM4PadString("",50,padchar,false), accessArea); //RESRV2     				 	  AddTextToArea(NewM4PadString("",50,padchar,false), accessArea); //RESRV3     				 	  AddTextToArea(NewM4PadString("",50,padchar,false), accessArea); //RESRV4                AddTextToArea("Z" & linefeed, accessArea); //ITMFLG                end;            end;          end;        end;  	      end;    end;    	  ISr.Location = locations;    TrHs = true;    while (LoopKey("Location",ISr,1,TrHs)) begin      if (ISr.Location!=locations) then begin TrHs=false; end;      if (TrHs) then begin        INr.Code = ISr.Code;        if (ReadFirstMain(INr,1,true) and INr.Terminated==0) then begin          if (INr.Group=="SAMSU" or INr.Group=="SMG_A") then begin  //Inventory Set-Samsung & Accessory-Samsung            tval = inventoryList[ISr.Code];            if (NonBlank(INr.EUCodex)) then begin               identificator =  INr.EUCodex;            end else begin              identificator = INr.Code;            end;            if ((ISr.Instock - tval)>0 and findf[identificator]==true) then begin              AddTextToArea(NewM4PadString(SFtpb.SenderCode,10,padchar,false), inventArea); //PTNCOD  				 	  AddTextToArea(NewM4PadString(senddate,8,padchar,false), inventArea); //ITMDAT  				 	  AddTextToArea(NewM4PadString("",8,padchar,false), inventArea); //STADAT  				 	  AddTextToArea(NewM4PadString("",8,padchar,false), inventArea); //ENDDAT  				 	  AddTextToArea(NewM4PadString(identificator,20,padchar,false), inventArea); //SECMOD  				 	  AddTextToArea(NewM4PadString("",20,padchar,false), inventArea); //EANUPC// Edit ************************** Friday, 29 April 2016 16:52:07  				 	  AddTextToArea(NewM4PadString("",30,padchar,false), inventArea); //PTNMOD// Edit ************************** Friday, 29 April 2016 16:52:06  				 	  AddTextToArea(NewM4PadString(SFtpb.LocationCode,30,padchar,false), inventArea); //LOCCOD  				 	  AddTextToArea(NewM4PadString("ST",2,padchar,false), inventArea); //LOCTYP  				 	  AddTextToArea(NewM4PadString("",20,padchar,false), inventArea); //CHNSRC  				 	  AddTextToArea(NewM4PadString("",20,padchar,false), inventArea); //CHNCAT  				 	  AddTextToArea(NewM4PadString("",20,padchar,false), inventArea); //PTN2CD  				 	  AddTextToArea(NewM4PadString("",20,padchar,false), inventArea); //PTNAGT  				 	  AddTextToArea(NewM4PadString("IO",10,padchar,false), inventArea); //QTYTYP  				 	  AddTextToArea(NewM4PadString(ISr.Instock - tval,10,padchar,false), inventArea); //QTY  				 	  AddTextToArea(NewM4PadString("",10,padchar,false), inventArea); //AMT  				 	  AddTextToArea(NewM4PadString("",3,padchar,false), inventArea); //CUR  				 	  AddTextToArea(NewM4PadString("",50,padchar,false), inventArea); //RESRV1  				 	  AddTextToArea(NewM4PadString("",50,padchar,false), inventArea); //RESRV2  				 	  AddTextToArea(NewM4PadString("",50,padchar,false), inventArea); //RESRV3  				 	  AddTextToArea(NewM4PadString("",50,padchar,false), inventArea); //RESRV4  				 	  AddTextToArea("Z" & linefeed, inventArea); //ITMFLG              end;          end;        end;       end;    end;	 	 	 	SSLr.SerNr = NextSerNr("SamsungSendLog1Vc",CurrentDate,-1,true,"");			SSLr.TransDate = sd;			SSLr.CurDate = CurrentDate;			SSLr.TransTime = CurrentTime;			SSLr.FileName1 = filenameIMEI;			SSLr.FileName2 = filenameAcces;			SSLr.FileName3 = filenameInvent;		recordstore(SSLr,true);	 	  if (includeIMEI) then begin	    WriteAreaToFile(IMEIarea,folder & filenameIMEI,0);	    millisleep(50);	    SendFileFTP(SFtpb,filenameIMEI);	    SFtpb.SalesNextDocNum = SFtpb.SalesNextDocNum + 1;	  end;	  if (includeAcces) then begin      WriteAreaToFile(accessArea,folder & filenameAcces,0);      millisleep(50);      SendFileFTP(SFtpb,filenameAcces);      SFtpb.SalesNextDocNum2 = SFtpb.SalesNextDocNum2 + 1;    end;    WriteAreaToFile(inventArea,folder & filenameInvent,0);    millisleep(50);    SendFileFTP(SFtpb,filenameInvent);	  BlockStore(SFtpb);	  LSamsungSendFilesToFtpMn:;				  return;end;global updating procedure SamsungSendFilesByMailEXCELMn(record RcVc RepSpec)begin  record SamsungSettingsBlock SFtpb;  record IVcashVc IVcashr;  row IVcashVc IVcashrw;  record INVc INr;  record SysFormatBlock SysFormatRec;  record SHVc SHr;  row SHVc SHrw;  record ORVc ORr;  row ORVc ORrw;  record ItemStatusVc ISr;  date sd,ed;  string 255 locations,mailSubject,tstr,curindex;  boolean TrHs,testf,proccedf;  string 30 salesdate,itemCode,identificator;  integer i,rwcnt,pos,invoiceCnt;  vector val qtySetCodes,qtyAccesSumsCodes,qtyAccesOthersCodes;  vector val qtySetList,qtyAccesSumsList,qtyAccesOthersList;  vector LongInt serNrSetCodes, serNrAccesSumsCodes, serNrAccesOthersCodes;  vector val priceSetCodes, priceAccesSumsCodes, priceAccesOthersCodes;  array string 255 indexes;  val tval;    array string 10 sheetNames;	array val sheetColls;	array integer sheetCollsOutLvl;	array string 21 mergeCell;	string 255 fileToSave;	integer qtyOfSheets,sheetnum,rownum,colnum,style,qtyOfEmpStr;	array string 100 SharedStrings;	integer numOfUniqueSharedStrings,numOfSharedStrings,qtyMergeCell;	string 16 reportName;  array integer lvlArray;  array string 255 mas;    BlockLoad(SFtpb);  if (blank(SFtpb.Locations) or blank(SFtpb.DirName)) then begin    goto LSamsungSendFilesByMailEXCELMn;  end;  sd = RepSpec.sStartDate;  ed = RepSpec.sEndDate;  locations = SFtpb.Locations; //for now only one location is allowed    if (BlankDate(sd)) then begin    sd = CurrentDate;  end;  if (BlankDate(ed)) then begin   ed = sd;  end;  LogText(0,"Period " & sd & ":" & ed);     salesdate = DateToString(sd,"YYYYMMDD");     mailSubject = "[EDI_SELL_OUT] " & SFtpb.SenderName & " " & salesdate;    TrHs = true;  IVcashr.TransDate = sd;  invoiceCnt = 0;  While(LoopKey("TransDate",IVcashr,1,TrHs)) begin    testf = true;    if (blank(IVcashr.Location) or IVcashr.Location!=locations) then begin testf = false; end;    if (IVcashr.TransDate<sd) then begin testf = false; end;    if (IVcashr.TransDate>ed) then begin TrHs = false; testf = false; end;    if (testf) then begin      invoiceCnt = invoiceCnt + 1;      rwcnt = MatRowCnt(IVcashr);      for(i=0;i<rwcnt;i=i+1) begin        MatRowGet(IVcashr,i,IVcashrw);        if (IVcashrw.stp==kInvoiceRowTypeNormal and NonBlank(IVcashrw.ArtCode)) then begin          INr.Code = IVcashrw.ArtCode;          ReadFirstMain(INr,1,true);          if (INr.Terminated==1) then begin testf=false; end;          if (INr.Code=="PREPAYMENT") then begin testf=false; end;          if (testf) then begin            if (INr.Group=="SAMSU") then begin //SET              if ((NonBlank(IVcashrw.SerialNr) or NonBlank(IVcashrw.IMEI)) /*and                  (NonBlank(INr.EUCodex) or (NonBlank(INr.BarCode) and len(INr.BarCode)==13) and IsStringNumeric(INr.BarCode))*/) then begin                proccedf = false;                if (NonBlank(IVcashrw.IMEI)) then begin                  curindex = IVcashrw.ArtCode & ";" & IVcashrw.IMEI;                  proccedf = true;                end else begin                  curindex = IVcashrw.ArtCode & ";" & IVcashrw.SerialNr;                  proccedf = true;                end;                if (proccedf) then begin                  //vectors for sale                  if (IVcashrw.Quant>0) then begin                    qtySetCodes[curindex] = qtySetCodes[curindex] + IVcashrw.Quant;                    serNrSetCodes[curindex] = IVcashr.SerNr;                    priceSetCodes[curindex] = IVcashrw.Price;                  end else begin                    qtySetCodes[curindex] = qtySetCodes[curindex] - IVcashrw.Quant;                  end;                end;                                //vector for inventory                if (IVcashrw.Quant>0) then begin                  qtySetList[IVcashrw.ArtCode] = qtySetList[IVcashrw.ArtCode] + IVcashrw.Quant;                end else begin                  qtySetList[IVcashrw.ArtCode] = qtySetList[IVcashrw.ArtCode] - IVcashrw.Quant;                end;              end;            end else begin //Accessory              if (INr.Group=="SMG_A") then begin                proccedf = false;                if (NonBlank(INr.EUCodex)) then begin                  curindex = IVcashrw.ArtCode & ";" & INr.EUCodex;                  proccedf = true;                end else begin                  /*if (NonBlank(INr.BarCode) and len(INr.BarCode)==13 and IsStringNumeric(INr.BarCode)) then begin                    curindex = IVcashrw.ArtCode & ";" & INr.BarCode;                    proccedf = true;                  end else begin*/                    curindex = IVcashrw.ArtCode & ";" & IVcashrw.ArtCode;                    proccedf = true;                  //end;                end;                if (proccedf) then begin                  //vectors for sale                  if (IVcashrw.Quant>0) then begin                    qtyAccesSumsCodes[curindex] = qtyAccesSumsCodes[curindex] + IVcashrw.Quant;                    serNrAccesSumsCodes[curindex] = IVcashr.SerNr;                    priceAccesSumsCodes[curindex] = IVcashrw.Price;                  end else begin                    qtyAccesSumsCodes[curindex] = qtyAccesSumsCodes[curindex] - IVcashrw.Quant;                  end;                end;                                //vector for inventory                if (IVcashrw.Quant>0) then begin                  qtyAccesSumsList[IVcashrw.ArtCode] = qtyAccesSumsList[IVcashrw.ArtCode] + IVcashrw.Quant;                end else begin                  qtyAccesSumsList[IVcashrw.ArtCode] = qtyAccesSumsList[IVcashrw.ArtCode] - IVcashrw.Quant;                end;                  	                      /*end else begin                curindex = IVcashrw.ArtCode;                //vectors for sale                if (IVcashrw.Quant>0) then begin                  qtyAccesOthersCodes[curindex] = qtyAccesOthersCodes[curindex] + IVcashrw.Quant;                  serNrAccesOthersCodes[curindex] = IVcashr.SerNr;                  priceAccesOthersCodes[curindex] = IVcashrw.Price;                end else begin                  qtyAccesOthersCodes[curindex] = qtyAccesOthersCodes[curindex] - IVcashrw.Quant;                end;                                //vector for inventory                if (IVcashrw.Quant>0) then begin                  qtyAccesOthersList[IVcashrw.ArtCode] = qtyAccesOthersList[IVcashrw.ArtCode] + IVcashrw.Quant;                 end else begin                  qtyAccesOthersList[IVcashrw.ArtCode] = qtyAccesOthersList[IVcashrw.ArtCode] - IVcashrw.Quant;                end;*/              end;            end;          end;        end;      end;  	    end;  end;    TrHs = true;  SHr.ShipDate = sd;  //invoiceCnt = 0;  While(LoopKey("ShipDate",SHr,1,TrHs)) begin    testf = true;    if (blank(SHr.Location) or SHr.Location!=locations) then begin testf = false; end;    if (SHr.ShipDate<sd) then begin testf = false; end;    if (SHr.ShipDate>ed) then begin TrHs = false; testf = false; end;    if (testf) then begin      invoiceCnt = invoiceCnt + 1;      rwcnt = MatRowCnt(SHr);      for(i=0;i<rwcnt;i=i+1) begin        MatRowGet(SHr,i,SHrw);        if (NonBlank(SHrw.ArtCode)) then begin          INr.Code = SHrw.ArtCode;          ReadFirstMain(INr,1,true);          if (INr.Terminated==1) then begin testf=false; end;          if (INr.Code=="PREPAYMENT") then begin testf=false; end;          if (testf) then begin            if (INr.Group=="SAMSU") then begin //SET              if ((NonBlank(SHrw.SerialNr) or NonBlank(SHrw.IMEI)) /*and                  (NonBlank(INr.EUCodex) or (NonBlank(INr.BarCode) and len(INr.BarCode)==13) and IsStringNumeric(INr.BarCode))*/) then begin                proccedf = false;                if (NonBlank(SHrw.IMEI)) then begin                  curindex = SHrw.ArtCode & ";" & SHrw.IMEI;                  proccedf = true;                end else begin                  curindex = SHrw.ArtCode & ";" & SHrw.SerialNr;                  proccedf = true;                end;                if (proccedf) then begin                  //vectors for sale                  if (SHrw.Ship>0) then begin                    qtySetCodes[curindex] = qtySetCodes[curindex] + SHrw.Ship;                    serNrSetCodes[curindex] = SHr.SerNr;                    ORr.SerNr = SHr.OrderNr;                    ReadFirstMain(ORr,1,true);                    MatRowGet(ORr,SHrw.OrdRow,ORrw);                    priceSetCodes[curindex] = ORrw.Price;                  end else begin                    qtySetCodes[curindex] = qtySetCodes[curindex] - SHrw.Ship;                  end;                end;              end;            end else begin //Accessory              if (INr.Group=="SMG_A") then begin                proccedf = false;                if (NonBlank(INr.EUCodex)) then begin                  curindex = SHrw.ArtCode & ";" & INr.EUCodex;                  proccedf = true;                end else begin                  /*if (NonBlank(INr.BarCode) and len(INr.BarCode)==13 and IsStringNumeric(INr.BarCode)) then begin                    curindex = SHrw.ArtCode & ";" & INr.BarCode;                    proccedf = true;                  end else begin*/                    curindex = SHrw.ArtCode & ";" & SHrw.ArtCode;                    proccedf = true;                  //end;                end;                if (proccedf) then begin                  //vectors for sale                  if (SHrw.Ship>0) then begin                    qtyAccesSumsCodes[curindex] = qtyAccesSumsCodes[curindex] + SHrw.Ship;                    serNrAccesSumsCodes[curindex] = SHr.SerNr;                    ORr.SerNr = SHr.OrderNr;                    ReadFirstMain(ORr,1,true);                    MatRowGet(ORr,SHrw.OrdRow,ORrw);                    priceAccesSumsCodes[curindex] = ORrw.Price;                  end else begin                    qtyAccesSumsCodes[curindex] = qtyAccesSumsCodes[curindex] - SHrw.Ship;                  end;                end;                /*end else begin                curindex = SHrw.ArtCode;                //vectors for sale                if (SHrw.Ship>0) then begin                  qtyAccesOthersCodes[curindex] = qtyAccesOthersCodes[curindex] + SHrw.Ship;                  serNrAccesOthersCodes[curindex] = SHr.SerNr;                  ORr.SerNr = SHr.OrderNr;                  ReadFirstMain(ORr,1,true);                  MatRowGet(ORr,SHrw.OrdRow,ORrw);                  priceAccesOthersCodes[curindex] = ORrw.Price;                end else begin                  qtyAccesOthersCodes[curindex] = qtyAccesOthersCodes[curindex] - SHrw.Ship;                end;*/              end;            end;          end;        end;      end;  	    end;  end;    reportName = "SamsungSendFilesByMailEXCEL";  if (windowsmode==1) then begin    fileToSave = "Samsunglsx.xlsx";  end else begin    fileToSave = "/Samsungxlsx.xlsx";  end;  deletefolder(Left(fileToSave,(len(fileToSave) - 5)));  qtyOfSheets = 3;  sheetNames[0] = "SET";  sheetNames[1] = "Accessory";  sheetNames[2] = "Inventory";    numOfUniqueSharedStrings = 0;  numOfSharedStrings = 0;    XmlXlsxWorkBegin(fileToSave,reportName);  CreateSheetsXLSX(qtyOfSheets,sheetNames,fileToSave,0,false);      colnum = 0;    sheetColls[colnum] = 21;    colnum = colnum + 1;    sheetColls[colnum] = 18.28515625;    colnum = colnum + 1;    sheetColls[colnum] = 33;    colnum = colnum + 1;    sheetColls[colnum] = 28;    colnum = colnum + 1;    sheetColls[colnum] = 21.42578125;    colnum = colnum + 1;    sheetColls[colnum] = 16.42578125;    colnum = colnum + 1;    sheetColls[colnum] = 28.140625;    colnum = colnum + 1;    sheetColls[colnum] = 14.140625;        qtyMergeCell = 0;    sheetnum = 1;    SetSheetsCols(sheetnum,sheetColls,lvlArray,fileToSave);    BeginSheetData(sheetnum,fileToSave);      rownum = 1;      colnum = 1;      BeginRow(sheetnum,fileToSave,rownum,0,blankval); //SET header        style = 7;				StringCell(sheetnum,fileToSave,colnum,rownum,style,SFtpb.SenderCode,SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,salesdate,SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        style = 8;        NumericCell(sheetnum,fileToSave,colnum,rownum,style,invoiceCnt+1); //Visitors        NumericCell(sheetnum,fileToSave,colnum,rownum,style,invoiceCnt); //Customers      EndRow(sheetnum,fileToSave,rownum);      colnum = 1;      BeginRow(sheetnum,fileToSave,rownum,0,blankval);        style = 6;        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Серийный номер",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Цена товара",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"ФИО Покупателя",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Номер телефона покупателя",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Адрес электронной почты",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Номер чека",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Номер участника программы",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Номер купона",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);      EndRow(sheetnum,fileToSave,rownum);      GetVectorTags(qtySetCodes,indexes);      for(i=0;i<indexes.length;i=i+1) begin //SET items        curindex = indexes[i];        pos = 0;        ExtractObjWithSeparator(";",curindex,false,pos,itemCode);        ExtractObjWithSeparator(";",curindex,false,pos,identificator);        if (qtySetCodes[curindex]>0) then begin          colnum = 1;            BeginRow(sheetnum,fileToSave,rownum,0,blankval);            style = 4;            StringCell(sheetnum,fileToSave,colnum,rownum,style,identificator,SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            //tstr = ValToString(priceSetCodes[curindex],M4Val,"",SysFormatRec.decimalPt,0);            style = 5;            NumericCell(sheetnum,fileToSave,colnum,rownum,style,priceSetCodes[curindex]);            style = 4;            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,serNrSetCodes[curindex],SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);          EndRow(sheetnum,fileToSave,rownum);        end;      end;    EndSheetData(sheetnum,fileToSave);    MergeCells(sheetnum,fileToSave,mergeCell,qtyMergeCell);    EndSheet(sheetnum,fileToSave,0);        ClearArray(sheetColls);    colnum = 0;    sheetColls[colnum] = 16.28515625;    colnum = colnum + 1;    sheetColls[colnum] = 11.85546875;    colnum = colnum + 1;    sheetColls[colnum] = 12.28515625;    colnum = colnum + 1;    sheetColls[colnum] = 33.140625;    colnum = colnum + 1;    sheetColls[colnum] = 28;    colnum = colnum + 1;    sheetColls[colnum] = 8.85546875;    colnum = colnum + 1;    sheetColls[colnum] = 60.85546875;    colnum = colnum + 1;    sheetColls[colnum] = 12.140625;    colnum = colnum + 1;    sheetColls[colnum] = 28.140625;    colnum = colnum + 1;    sheetColls[colnum] = 14.140625;        qtyMergeCell = 0;    sheetnum = sheetnum + 1;    SetSheetsCols(sheetnum,sheetColls,lvlArray,fileToSave);    BeginSheetData(sheetnum,fileToSave);      rownum = 1;      colnum = 1;      BeginRow(sheetnum,fileToSave,rownum,0,blankval); //Accessory header        style = 9;        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Код модели",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Количество продаж",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Цена товара",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"ФИО Покупателя",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Номер телефона покупателя",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Бренд",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Адрес электронной почты",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Номер чека",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Номер участника программы",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Номер купона",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);      EndRow(sheetnum,fileToSave,rownum);      GetVectorTags(qtyAccesSumsCodes,indexes); //Accessory Samsung      for(i=0;i<indexes.length;i=i+1) begin        curindex = indexes[i];        pos = 0;        ExtractObjWithSeparator(";",curindex,false,pos,itemCode);        ExtractObjWithSeparator(";",curindex,false,pos,identificator);        if (qtyAccesSumsCodes[curindex]>0) then begin          colnum = 1;            BeginRow(sheetnum,fileToSave,rownum,0,blankval);            style = 4;            StringCell(sheetnum,fileToSave,colnum,rownum,style,identificator,SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            style = 5;            NumericCell(sheetnum,fileToSave,colnum,rownum,style,qtyAccesSumsCodes[curindex]);            NumericCell(sheetnum,fileToSave,colnum,rownum,style,priceAccesSumsCodes[curindex]);            //tstr = ValToString(priceAccesSumsCodes[curindex],M4Val,"",SysFormatRec.decimalPt,0);            style = 4;            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"Samsung",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,serNrAccesSumsCodes[curindex],SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);          EndRow(sheetnum,fileToSave,rownum);        end;      end;      GetVectorTags(qtyAccesOthersCodes,indexes); //Accessory Others      for(i=0;i<indexes.length;i=i+1) begin        curindex = indexes[i];        pos = 0;        //ExtractObjWithSeparator(";"curindex,false,pos,itemCode);        //ExtractObjWithSeparator(";",curindex,false,pos,identificator);        if (qtyAccesOthersCodes[curindex]>0) then begin          colnum = 1;            BeginRow(sheetnum,fileToSave,rownum,0,blankval);            style = 4;            StringCell(sheetnum,fileToSave,colnum,rownum,style,curindex,SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            style = 5;            NumericCell(sheetnum,fileToSave,colnum,rownum,style,qtyAccesOthersCodes[curindex]);            NumericCell(sheetnum,fileToSave,colnum,rownum,style,priceAccesOthersCodes[curindex]);            //tstr = ValToString(priceAccesOthersCodes[curindex],M4Val,"",SysFormatRec.decimalPt,0);            style = 4;            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"Others",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,serNrAccesOthersCodes[curindex],SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);            StringCell(sheetnum,fileToSave,colnum,rownum,style,"",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);          EndRow(sheetnum,fileToSave,rownum);        end;      end;    EndSheetData(sheetnum,fileToSave);    MergeCells(sheetnum,fileToSave,mergeCell,qtyMergeCell);    EndSheet(sheetnum,fileToSave,0);        ClearArray(sheetColls);    colnum = 0;    sheetColls[colnum] = 18.5703125;    colnum = colnum + 1;    sheetColls[colnum] = 22.42578125;    colnum = colnum + 1;    sheetColls[colnum] = 15.28515625;        qtyMergeCell = 0;    sheetnum = sheetnum + 1;    SetSheetsCols(sheetnum,sheetColls,lvlArray,fileToSave);    BeginSheetData(sheetnum,fileToSave);      rownum = 1;      colnum = 1;      BeginRow(sheetnum,fileToSave,rownum,0,blankval); //Inventory header        style = 3;        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Код модели",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Кол-во остатков",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Тип продукта",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);        StringCell(sheetnum,fileToSave,colnum,rownum,style,"Бренд",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);      EndRow(sheetnum,fileToSave,rownum);            ISr.Location = locations;      TrHs = true;      while (LoopKey("Location",ISr,1,TrHs)) begin        if (ISr.Location!=locations) then begin TrHs=false; end;        if (TrHs) then begin          INr.Code = ISr.Code;          if (ReadFirstMain(INr,1,true) and INr.Terminated==0) then begin            if (INr.Group=="SAMSU") then begin  //Inventory Set-Samsung              tval = qtySetList[ISr.Code];              if (/*(NonBlank(INr.EUCodex) or (NonBlank(INr.BarCode) and len(INr.BarCode)==13) and IsStringNumeric(INr.BarCode))                   and*/ (ISr.Instock - tval)>0) then begin                if (NonBlank(INr.EUCodex)) then begin                   identificator =  INr.EUCodex;                end else begin                  //identificator = INr.BarCode;                  identificator = INr.Code;                end;                colnum = 1;                  BeginRow(sheetnum,fileToSave,rownum,0,blankval);                  style = 4;                  StringCell(sheetnum,fileToSave,colnum,rownum,style,identificator,SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);                  style = 5;                  NumericCell(sheetnum,fileToSave,colnum,rownum,style,ISr.Instock - tval);                  style = 4;                  StringCell(sheetnum,fileToSave,colnum,rownum,style,"Set",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);                  StringCell(sheetnum,fileToSave,colnum,rownum,style,"Samsung",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);                EndRow(sheetnum,fileToSave,rownum);              end;            end else begin //Inventory Accessory-Samsung              if (INr.Group=="SMG_A") then begin                tval = qtyAccesSumsList[ISr.Code];                if ((ISr.Instock - tval)>0) then begin                  if (NonBlank(INr.EUCodex)) then begin                     identificator = INr.EUCodex;                  end else begin                    /*if (NonBlank(INr.BarCode) and len(INr.BarCode)==13 and IsStringNumeric(INr.BarCode)) then begin                      identificator = INr.BarCode;                    end else begin*/                      identificator = INr.Code;                    //end;                  end;                  colnum = 1;                    BeginRow(sheetnum,fileToSave,rownum,0,blankval);                    style = 4;                    StringCell(sheetnum,fileToSave,colnum,rownum,style,identificator,SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);                    style = 5;                    NumericCell(sheetnum,fileToSave,colnum,rownum,style,ISr.Instock - tval);                    style = 4;                    StringCell(sheetnum,fileToSave,colnum,rownum,style,"Accessory",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);                    StringCell(sheetnum,fileToSave,colnum,rownum,style,"Samsung",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);                  EndRow(sheetnum,fileToSave,rownum);                end;              end else begin //Inventory Accessory-Others                tval = qtyAccesOthersList[ISr.Code];                if ((ISr.Instock - tval)>0) then begin                  colnum = 1;                    BeginRow(sheetnum,fileToSave,rownum,0,blankval);                    style = 4;                    StringCell(sheetnum,fileToSave,colnum,rownum,style,ISr.Code,SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);                    style = 5;                    NumericCell(sheetnum,fileToSave,colnum,rownum,style,ISr.Instock - tval);                    style = 4;                    StringCell(sheetnum,fileToSave,colnum,rownum,style,"Accessory",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);                    StringCell(sheetnum,fileToSave,colnum,rownum,style,"Others",SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings);                  EndRow(sheetnum,fileToSave,rownum);                end;              end;            end;          end;         end;      end;          EndSheetData(sheetnum,fileToSave);    MergeCells(sheetnum,fileToSave,mergeCell,qtyMergeCell);    EndSheet(sheetnum,fileToSave,0);  FillSharedStrings(fileToSave,SharedStrings,numOfUniqueSharedStrings,numOfSharedStrings,mas);  ConvertToXLSX(fileToSave,false);  LSamsungSendFilesByMailEXCELMn:;    return;end;global webpublic updating Procedure WebSamsungSentToFtp() //Edit***************************Sasha2,15:18 04.07.2014begin	integer compnr;	record RcVc RepSpec;	area subj;	Integer curcomp;	date sd;	string 20 sdate;		 curcomp = CurrentCompany;	 if (SetCompany(9,false)) then begin	 	 sdate = webgetarg("date");	 	 if(nonblank(sdate))then begin	 	 	RepSpec.sStartDate = stringtodate(sdate);  	 	RepSpec.sEndDate = RepSpec.sStartDate;	   	SamsungSendFilesToFtpMn(RepSpec);	 	 end else begin	 	 	RepSpec.sStartDate = currentdate;  	 	RepSpec.sEndDate = RepSpec.sStartDate;	   	SamsungSendFilesToFtpMn(RepSpec);	 	 end;	   	   ResetCompany(curcomp); 	 end;	 	return;end; 